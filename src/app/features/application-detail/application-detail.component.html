<div class="container mx-auto p-4 md:p-8">
    <div *ngIf="application$ | async as application; else loadingApp">
  
      <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-2 sm:space-y-0">
        <div class="flex items-center space-x-4">
          <a routerLink="/applications" class="text-gray-400 hover:text-white transition" title="Zurück zur Übersicht">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
          </a>
          <div>
            <h1 class="text-2xl font-bold text-white">{{ application.company }}</h1>
            <p class="text-gray-400">{{ application.position }}</p>
          </div>
        </div>
        <a [routerLink]="['/applications', application.id, 'edit']" class="bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold py-2 px-4 rounded transition duration-300 self-end sm:self-auto">Bearbeiten</a>
      </div>
  
      <div class="bg-gray-900 rounded-lg border border-gray-800 p-6 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div><p class="text-gray-400 text-sm">Status</p><p class="text-white mt-1"><span class="px-3 py-1 rounded-full text-xs font-medium" [ngClass]="getStatusColor(application.status)">{{ application.status }}</span></p></div>
          <div><p class="text-gray-400 text-sm">Beworben am</p><p class="text-white mt-1">{{ application.date | date:'dd.MM.yyyy' }}</p></div>
          <div><p class="text-gray-400 text-sm">Ort</p><p class="text-white mt-1">{{ application.location || '-' }}</p></div>
          <div><p class="text-gray-400 text-sm">Interne ID</p><p class="text-white mt-1 text-xs break-all">{{ application.id }}</p></div>
        </div>
      </div>
  
      <div class="mb-6 border-b border-gray-700">
        <div class="block sm:hidden">
          <label for="tabs-select" class="sr-only">Select a tab</label>
          <select id="tabs-select" name="tabs"
                  class="block w-full rounded-md border-gray-700 bg-gray-800 py-2 pl-3 pr-10 text-base text-white focus:border-purple-500 focus:outline-none focus:ring-purple-500 sm:text-sm"
                  [(ngModel)]="activeTab"
                  (ngModelChange)="setActiveTab($event)">
            <option *ngFor="let tab of tabOptions" [value]="tab.key">{{ tab.label }}</option>
          </select>
        </div>
        <nav class="-mb-px hidden sm:flex space-x-4 sm:space-x-8 overflow-x-auto pb-px" aria-label="Tabs">
          <button *ngFor="let tab of tabOptions"
                  (click)="setActiveTab(tab.key)"
                  [attr.aria-current]="activeTab === tab.key ? 'page' : null"
                  [class.border-purple-500]="activeTab === tab.key"
                  [class.text-white]="activeTab === tab.key"
                  [class.border-transparent]="activeTab !== tab.key"
                  [class.text-gray-400]="activeTab !== tab.key"
                  [class.hover:text-gray-200]="activeTab !== tab.key"
                  [class.hover:border-gray-500]="activeTab !== tab.key"
                  class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition">
            {{ tab.label }}
          </button>
        </nav>
      </div>
  
      <div [ngSwitch]="activeTab">
  
        <div *ngSwitchCase="'timeline'" class="space-y-5">
          <h2 class="text-xl font-semibold text-white mb-4">Aktivitätsverlauf</h2>
          <div *ngIf="timeline$ | async as timelineItems; else loadingTimeline">
            <div *ngIf="timelineItems.length > 0; else noTimelineItems">
              <div class="relative border-l border-gray-700 ml-5 pl-8 space-y-6">
                <div *ngFor="let item of timelineItems" class="relative">
                   <div class="absolute -left-[34px] top-1 flex items-center justify-center w-6 h-6 rounded-full bg-gray-700 ring-8 ring-gray-950">
                     <span class="text-xs">{{ getTimelineItemIcon(item) }}</span>
                   </div>
                   <div class="p-4 bg-gray-900 rounded-lg border border-gray-800 shadow-sm">
                     <div class="flex flex-col items-start sm:flex-row sm:items-center sm:justify-between gap-1 mb-2">
                       <span class="font-semibold text-base text-white break-words">{{ item.title || item.type }}</span>
                       <time class="text-xs font-normal text-gray-500 flex-shrink-0">{{ item.timestamp | date:'dd.MM.yyyy, HH:mm' }}</time>
                     </div>
                     <div class="text-sm text-gray-300">
                       <ng-container *ngIf="isStatusChangeItem(item)">Von <span class="font-medium text-gray-400">{{ item.data.oldStatus || 'N/A (Erstellt)' }}</span> nach <span class="font-medium text-white px-2 py-0.5 rounded" [ngClass]="getStatusColor(item.data.newStatus)">{{ item.data.newStatus }}</span></ng-container>
                       <ng-container *ngIf="isNoteItem(item)"><div class="whitespace-pre-wrap bg-gray-800/50 p-2 rounded">{{ item.data.content }}<div *ngIf="item.data.updatedAt" class="text-xs text-gray-500 mt-1">(Bearbeitet: {{ item.data.updatedAt | date:'dd.MM.yyyy, HH:mm' }})</div></div></ng-container>
                       <ng-container *ngIf="isCommunicationItem(item)"><p class="mb-1 whitespace-pre-wrap">{{ item.data.content }}</p><div class="flex flex-wrap gap-x-4 text-xs text-gray-500 mt-1"><span *ngIf="item.data.contactPerson">Kontakt: {{ item.data.contactPerson }}</span><span>Richtung: {{ item.data.direction === 'outgoing' ? 'Ausgehend' : 'Eingehend' }}</span><span>Typ: {{ item.data.type }}</span></div></ng-container>
                       <ng-container *ngIf="isReminderItem(item)"><p class="mb-1">{{ item.data.reminderText }}</p><p class="text-xs" [ngClass]="item.data.isCompleted ? 'text-green-500' : 'text-yellow-500'">Fällig: {{ item.data.date | date:'dd.MM.yyyy' }} {{ item.data.isCompleted ? '(Erledigt)' : '' }}<button *ngIf="!item.data.isCompleted" (click)="toggleReminderCompletion(item.data.id)" class="ml-2 text-xs text-purple-400 hover:text-purple-300">[Als erledigt markieren]</button></p></ng-container>
                       <ng-container *ngIf="isDocumentItem(item)"><p class="mb-1 flex flex-wrap items-center gap-x-2 gap-y-1"><span class="font-medium truncate min-w-0">{{ item.data.name }}</span><span class="text-xs px-1.5 py-0.5 rounded" [ngClass]="getDocumentTypeColor(item.data.type)">{{ getDocumentTypeLabel(item.data.type) }}</span><span *ngIf="item.data.version && item.data.version > 1" class="text-xs text-gray-500">(v{{ item.data.version! }})</span></p><p class="text-xs text-gray-500">Größe: {{ formatFileSize(item.data.fileSize) }}</p><div class="mt-2 space-x-2"><button (click)="previewDocument(item.data)" *ngIf="item.data.fileData" class="text-blue-400 hover:text-blue-300 text-xs">[Vorschau]</button><button (click)="downloadDocument(item.data)" *ngIf="item.data.fileData" class="text-green-400 hover:text-green-300 text-xs">[Download]</button><button (click)="deleteDocument(item.data)" class="text-red-400 hover:text-red-300 text-xs">[Löschen]</button></div></ng-container>
                     </div>
                   </div>
                 </div>
              </div>
            </div>
            <ng-template #noTimelineItems><div class="text-center py-10"><svg class="mx-auto h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3 class="mt-2 text-sm font-medium text-gray-300">Keine Aktivitäten</h3><p class="mt-1 text-sm text-gray-500">Für diese Bewerbung wurden noch keine Aktivitäten erfasst.</p></div></ng-template>
          </div>
          <ng-template #loadingTimeline><p class="text-center text-gray-500 py-10">Lade Aktivitätenverlauf...</p></ng-template>
        </div>
  
        <div *ngSwitchCase="'notes'" class="space-y-6">
          <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
             <h3 class="text-lg font-semibold text-white mb-4">Neue Notiz hinzufügen</h3>
             <textarea [(ngModel)]="newNoteContent" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent placeholder-gray-500" rows="3" placeholder="Notiz eingeben..."></textarea>
             <div class="mt-3 flex justify-end"><button (click)="addNote()" [disabled]="!newNoteContent.trim()" class="px-4 py-2 rounded-md bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Hinzufügen</button></div>
          </div>
          <div *ngIf="notes$ | async as notes; else loadingNotes">
             <div *ngIf="notes.length > 0; else noNotes">
               <h3 class="text-lg font-semibold text-white mb-4">Vorhandene Notizen</h3>
               <div class="space-y-4">
                 <div *ngFor="let note of notes" class="bg-gray-900 rounded-lg border border-gray-800 p-4">
                   <div class="flex justify-between items-start">
                     <div class="flex-1 mr-4"><p class="text-gray-300 whitespace-pre-wrap">{{ note.content }}</p><div class="mt-2 text-xs text-gray-500">Erstellt: {{ note.createdAt | date:'dd.MM.yyyy, HH:mm' }}<span *ngIf="note.updatedAt"> | Bearbeitet: {{ note.updatedAt | date:'dd.MM.yyyy, HH:mm' }}</span></div></div>
                     <button (click)="deleteNote(note.id)" class="text-red-500 hover:text-red-400 flex-shrink-0" title="Notiz löschen"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                   </div>
                 </div>
               </div>
             </div>
             <ng-template #noNotes><p class="text-center text-gray-500 py-10">Noch keine Notizen für diese Bewerbung vorhanden.</p></ng-template>
           </div>
           <ng-template #loadingNotes><p class="text-center text-gray-500 py-10">Lade Notizen...</p></ng-template>
        </div>
  
        <div *ngSwitchCase="'communications'" class="space-y-6">
           <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
             <h3 class="text-lg font-semibold text-white mb-4">Neue Kommunikation erfassen</h3>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
               <div><label for="comm-type" class="block text-sm font-medium text-gray-300 mb-1">Typ</label><select id="comm-type" [(ngModel)]="newCommunication.type" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"><option value="email">E-Mail</option><option value="phone">Telefon</option><option value="meeting">Meeting</option><option value="other">Sonstiges</option></select></div>
               <div><label for="comm-direction" class="block text-sm font-medium text-gray-300 mb-1">Richtung</label><select id="comm-direction" [(ngModel)]="newCommunication.direction" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"><option value="outgoing">Ausgehend</option><option value="incoming">Eingehend</option></select></div>
               <div><label for="comm-date" class="block text-sm font-medium text-gray-300 mb-1">Datum</label><input id="comm-date" type="date" [(ngModel)]="newCommunicationDateString" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"></div>
               <div><label for="comm-contact" class="block text-sm font-medium text-gray-300 mb-1">Kontaktperson (Optional)</label><input id="comm-contact" type="text" [(ngModel)]="newCommunication.contactPerson" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent placeholder-gray-500" placeholder="z.B. Max Mustermann"></div>
               <div class="md:col-span-2"><label for="comm-subject" class="block text-sm font-medium text-gray-300 mb-1">Betreff</label><input id="comm-subject" type="text" [(ngModel)]="newCommunication.subject" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent placeholder-gray-500" placeholder="Betreff eingeben..."></div>
               <div class="md:col-span-2"><label for="comm-content" class="block text-sm font-medium text-gray-300 mb-1">Inhalt / Notizen</label><textarea id="comm-content" [(ngModel)]="newCommunication.content" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent placeholder-gray-500" rows="3" placeholder="Details zur Kommunikation..."></textarea></div>
             </div>
             <div class="mt-4 flex justify-end"><button (click)="addCommunication()" [disabled]="!newCommunication.subject.trim() || !newCommunication.content.trim()" class="px-4 py-2 rounded-md bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Hinzufügen</button></div>
           </div>
           <div *ngIf="communications$ | async as communications; else loadingCommunications">
             <div *ngIf="communications.length > 0; else noCommunications">
               <h3 class="text-lg font-semibold text-white mb-4">Erfasste Kommunikation</h3>
               <div class="space-y-4">
                 <div *ngFor="let comm of communications" class="bg-gray-900 rounded-lg border border-gray-800 p-4">
                   <div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-3"><span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="{'bg-blue-900 text-blue-400': comm.type === 'email','bg-green-900 text-green-400': comm.type === 'phone','bg-purple-900 text-purple-400': comm.type === 'meeting','bg-gray-800 text-gray-400': comm.type === 'other'}">{{ comm.type === 'email' ? 'E-Mail' : comm.type === 'phone' ? 'Telefon' : comm.type === 'meeting' ? 'Meeting' : 'Sonstiges' }}</span><span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="{'bg-pink-900 text-pink-400': comm.direction === 'outgoing','bg-cyan-900 text-cyan-400': comm.direction === 'incoming'}">{{ comm.direction === 'outgoing' ? 'Ausgehend' : 'Eingehend' }}</span></div><span class="text-sm text-gray-500">{{ comm.date | date:'dd.MM.yyyy, HH:mm' }}</span></div>
                   <h4 class="font-medium text-white mb-1">{{ comm.subject }}</h4>
                   <p class="text-gray-300 text-sm mb-2 whitespace-pre-wrap">{{ comm.content }}</p>
                   <p *ngIf="comm.contactPerson" class="text-sm text-gray-500">Kontaktperson: {{ comm.contactPerson }}</p>
                 </div>
               </div>
             </div>
             <ng-template #noCommunications><p class="text-center text-gray-500 py-10">Noch keine Kommunikation für diese Bewerbung erfasst.</p></ng-template>
           </div>
           <ng-template #loadingCommunications><p class="text-center text-gray-500 py-10">Lade Kommunikation...</p></ng-template>
        </div>
  
        <div *ngSwitchCase="'reminders'" class="space-y-6">
           <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
             <h3 class="text-lg font-semibold text-white mb-4">Neue Erinnerung hinzufügen</h3>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
               <div class="grid grid-cols-2 gap-2"><div><label for="rem-date" class="block text-sm font-medium text-gray-300 mb-1">Fälligkeitsdatum</label><input id="rem-date" type="date" [(ngModel)]="newReminderDateString" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"></div><div><label for="rem-time" class="block text-sm font-medium text-gray-300 mb-1">Uhrzeit</label><input id="rem-time" type="time" [(ngModel)]="newReminderTimeString" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"></div></div>
               <div><label for="rem-notify" class="block text-sm font-medium text-gray-300 mb-1">Benachrichtigung</label><select id="rem-notify" [(ngModel)]="newReminderNotifyBefore" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"><option [ngValue]="0">Zum Fälligkeitszeitpunkt</option><option [ngValue]="15">15 Minuten vorher</option><option [ngValue]="30">30 Minuten vorher</option><option [ngValue]="60">1 Stunde vorher</option><option [ngValue]="180">3 Stunden vorher</option><option [ngValue]="360">6 Stunden vorher</option><option [ngValue]="720">12 Stunden vorher</option><option [ngValue]="1440">1 Tag vorher</option><option [ngValue]="2880">2 Tage vorher</option><option [ngValue]="10080">1 Woche vorher</option></select></div>
               <div class="md:col-span-2"><label for="rem-text" class="block text-sm font-medium text-gray-300 mb-1">Erinnerungstext</label><textarea id="rem-text" [(ngModel)]="newReminder.reminderText" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent placeholder-gray-500" rows="2" placeholder="Erinnerung eingeben..."></textarea></div>
             </div>
             <div class="mt-4 flex justify-end"><button (click)="addReminder()" [disabled]="!newReminder.reminderText.trim()" class="px-4 py-2 rounded-md bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Hinzufügen</button></div>
           </div>
           <div *ngIf="reminders$ | async as reminders; else loadingReminders">
             <div *ngIf="reminders.length > 0; else noReminders">
               <h3 class="text-lg font-semibold text-white mb-4">Anstehende Erinnerungen</h3>
               <div class="space-y-4">
                 <div *ngFor="let reminder of reminders" class="bg-gray-900 rounded-lg border border-gray-800 p-4 transition" [ngClass]="{'opacity-60 border-l-4 border-green-600': reminder.isCompleted, 'border-l-4 border-yellow-600': !reminder.isCompleted}">
                   <div class="flex items-start">
                     <input type="checkbox" [id]="'reminder-' + reminder.id" [checked]="reminder.isCompleted" (change)="toggleReminderCompletion(reminder.id)" class="mt-1 mr-3 h-5 w-5 text-purple-600 rounded border-gray-600 bg-gray-700 focus:ring-purple-500 cursor-pointer">
                     <label [for]="'reminder-' + reminder.id" class="flex-1 cursor-pointer"><p class="text-gray-300" [ngClass]="{'line-through': reminder.isCompleted}">{{ reminder.reminderText }}</p><p class="text-sm text-gray-500 mt-1">Fällig: {{ reminder.date | date:'dd.MM.yyyy, HH:mm' }} Uhr <span class="text-xs ml-1">(Erstellt: {{ reminder.createdAt | date:'dd.MM.yyyy' }})</span></p><p *ngIf="reminder.notifyBefore" class="text-xs text-purple-400 mt-1">Benachrichtigung: <span *ngIf="reminder.notifyBefore === 0">Zum Fälligkeitszeitpunkt</span><span *ngIf="reminder.notifyBefore === 15">15 Minuten vorher</span><span *ngIf="reminder.notifyBefore === 30">30 Minuten vorher</span><span *ngIf="reminder.notifyBefore === 60">1 Stunde vorher</span><span *ngIf="reminder.notifyBefore === 180">3 Stunden vorher</span><span *ngIf="reminder.notifyBefore === 360">6 Stunden vorher</span><span *ngIf="reminder.notifyBefore === 720">12 Stunden vorher</span><span *ngIf="reminder.notifyBefore === 1440">1 Tag vorher</span><span *ngIf="reminder.notifyBefore === 2880">2 Tage vorher</span><span *ngIf="reminder.notifyBefore === 10080">1 Woche vorher</span><span *ngIf="reminder.notifyBefore && ![0, 15, 30, 60, 180, 360, 720, 1440, 2880, 10080].includes(reminder.notifyBefore)">{{ reminder.notifyBefore }} Minuten vorher</span></p></label>
                   </div>
                 </div>
               </div>
             </div>
             <ng-template #noReminders><p class="text-center text-gray-500 py-10">Keine Erinnerungen für diese Bewerbung vorhanden.</p></ng-template>
           </div>
           <ng-template #loadingReminders><p class="text-center text-gray-500 py-10">Lade Erinnerungen...</p></ng-template>
        </div>
  
        <div *ngSwitchCase="'documents'" class="space-y-6">
           <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
             <h3 class="text-lg font-semibold text-white mb-4">Dokument hochladen</h3>
             <div class="flex flex-col space-y-4">
               <div class="flex items-center justify-center w-full"><label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-700 border-dashed rounded-lg cursor-pointer bg-gray-800 hover:bg-gray-700 transition"><div class="flex flex-col items-center justify-center pt-5 pb-6"><svg class="w-8 h-8 mb-4 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg><p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Klicke zum Hochladen</span> oder ziehe Dateien hier hin</p><p class="text-xs text-gray-500">PDF, DOC(X), Bilder (MAX. 10MB)</p></div><input id="dropzone-file" type="file" class="hidden" accept=".pdf,.doc,.docx,image/*" (change)="onFileSelected($event)" /></label></div>
               <div *ngIf="selectedFile" class="text-sm text-gray-400">Ausgewählt: {{ selectedFile.name }} ({{ formatFileSize(selectedFile.size) }})</div>
               <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4"><select [(ngModel)]="selectedDocumentType" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"><option value="lebenslauf">Lebenslauf</option><option value="anschreiben">Anschreiben</option><option value="zeugnis">Arbeitszeugnis</option><option value="andere">Andere</option></select><button (click)="uploadDocument()" [disabled]="!selectedFile" class="px-4 py-2 rounded-md bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Hochladen</button></div>
             </div>
           </div>
           <div *ngIf="documents$ | async as documents; else loadingDocuments">
             <div *ngIf="documents.length > 0; else noDocuments">
               <h3 class="text-lg font-semibold text-white mb-4">Hochgeladene Dokumente</h3>
               <div class="space-y-4">
                 <div *ngFor="let doc of documents" class="bg-gray-900 rounded-lg border border-gray-800 p-4">
                   <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                     <div class="flex items-center space-x-4 mb-2 sm:mb-0"><div class="p-2 rounded-lg" [ngClass]="getDocumentTypeColor(doc.type)"><svg *ngIf="doc.fileType.startsWith('image/')" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4V5h12v10zm-9.414-4.586a1 1 0 01-1.414-1.414L6.172 8a1 1 0 011.414 0l.707.707a1 1 0 001.414 0L12.172 6a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-.707-.707a1 1 0 00-1.414 0l-1.414 1.414z" clip-rule="evenodd" /></svg><svg *ngIf="doc.fileType === 'application/pdf'" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H16L14,12L16,9H12L10,13H8L10,16H8L10,19Z"/></svg><svg *ngIf="!doc.fileType.startsWith('image/') && doc.fileType !== 'application/pdf'" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M16,11H8V13H16V11M16,15H8V17H16V15Z"/></svg></div><div><h4 class="font-medium text-white">{{ doc.name }}</h4><p class="text-sm text-gray-400">{{ getDocumentTypeLabel(doc.type) }} · {{ formatFileSize(doc.fileSize) }} · Hochgeladen: {{ doc.uploadDate | date:'dd.MM.yyyy' }}<span *ngIf="doc.version && doc.version > 1"> · Version {{ doc.version! }}</span></p></div></div>
                     <div class="flex space-x-2 mt-2 sm:mt-0 self-end sm:self-center"><button (click)="previewDocument(doc)" *ngIf="doc.fileData" class="p-1 text-blue-400 hover:text-blue-300 hover:bg-blue-900/30 rounded transition" title="Vorschau"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button><button (click)="downloadDocument(doc)" *ngIf="doc.fileData" class="p-1 text-green-400 hover:text-green-300 hover:bg-green-900/30 rounded transition" title="Herunterladen"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></button><button (click)="deleteDocument(doc)" class="p-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded transition" title="Löschen"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div>
                   </div>
                 </div>
               </div>
             </div>
             <ng-template #noDocuments><p class="text-center text-gray-500 py-10">Noch keine Dokumente für diese Bewerbung hochgeladen.</p></ng-template>
           </div>
           <ng-template #loadingDocuments><p class="text-center text-gray-500 py-10">Lade Dokumente...</p></ng-template>
        </div>
  
        <div *ngSwitchCase="'checklist'">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
              <h3 class="text-xl font-bold text-white">Checkliste für {{ application.company }}</h3>
              <p class="text-gray-400">{{ application.position }}</p>
            </div>
            <div class="flex space-x-3">
              <button *ngIf="!(checklist$ | async)?.length" (click)="showTemplateSelection()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white rounded transition">Checkliste erstellen</button>
              <button *ngIf="(checklist$ | async)?.length" (click)="addChecklistItem()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded transition">+ Aufgabe hinzufügen</button>
              <button *ngIf="(checklist$ | async)?.length" (click)="saveAsTemplate()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">Als Vorlage speichern</button>
            </div>
          </div>
          <div *ngIf="checklist$ | async as checklistItems; else loadingChecklist">
            <ng-container *ngIf="checklistItems.length > 0; else emptyChecklist">
              <div class="mb-6 bg-gray-900 rounded-lg border border-gray-800 p-6">
                <div class="flex justify-between items-center mb-3"><h4 class="text-lg font-semibold text-white">Gesamtfortschritt</h4><span class="text-lg font-bold text-white">{{ overallProgress }}%</span></div>
                <div class="w-full bg-gray-700 rounded-full h-3 mb-4"><div class="bg-gradient-to-r from-purple-600 to-pink-500 h-3 rounded-full" [style.width]="overallProgress + '%'"></div></div>
                <div *ngIf="categoryProgress && categoryProgress.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                  <div *ngFor="let category of categoryProgress" class="bg-gray-800 rounded p-3">
                    <div class="flex justify-between items-center mb-2"><h5 class="text-sm font-medium text-white">{{ category.category }}</h5><span class="text-sm text-gray-300">{{ category.progress }}%</span></div>
                    <div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" [style.width]="category.progress + '%'"></div></div>
                  </div>
                </div>
              </div>
              <div *ngFor="let category of getUniqueCategories(checklistItems)" class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-purple-500 mr-2"></span>{{ category }}</h4>
                <div class="space-y-2">
                  <div *ngFor="let item of filterByCategory(checklistItems, category)" class="bg-gray-900 rounded-lg border border-gray-800 hover:border-gray-700 p-4 transition">
                    <div class="flex items-start">
                      <input type="checkbox" [id]="'task-' + item.id" [checked]="item.isCompleted" (change)="toggleChecklistItem(item.id)" class="mt-1 mr-3 h-5 w-5 text-purple-600 rounded border-gray-600 bg-gray-700 focus:ring-purple-500 cursor-pointer">
                      <div class="flex-1">
                        <div class="flex justify-between mb-1">
                          <label [for]="'task-' + item.id" class="text-white cursor-pointer font-medium" [class.line-through]="item.isCompleted" [class.text-gray-400]="item.isCompleted">{{ item.task }}</label>
                          <div class="flex space-x-2 items-center flex-shrink-0">
                            <span [ngClass]="getPriorityBadgeClass(item.priority)" class="text-xs px-2 py-1 rounded-full">{{ getPriorityLabel(item.priority) }}</span>
                            <div class="flex space-x-1">
                              <button (click)="editChecklistItem(item)" class="text-blue-400 hover:text-blue-300 transition p-1 hover:bg-blue-900/30 rounded" title="Bearbeiten"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                              <button (click)="deleteChecklistItem(item.id, item.task)" class="text-red-400 hover:text-red-300 transition p-1 hover:bg-red-900/30 rounded" title="Löschen"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                            </div>
                          </div>
                        </div>
                        <div *ngIf="item.notes" class="mt-2 text-sm text-gray-400 bg-gray-800 rounded p-2 whitespace-pre-wrap">{{ item.notes }}</div>
                        <div *ngIf="item.dueDate" class="mt-2 text-xs text-gray-500">Fällig bis: {{ item.dueDate | date:'dd.MM.yyyy' }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #emptyChecklist>
              <div class="text-center py-12 bg-gray-900 rounded-lg border border-gray-800">
                <svg class="mx-auto h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-300">Keine Checkliste vorhanden</h3>
                <p class="mt-1 text-sm text-gray-500">Erstelle eine Checkliste für diese Bewerbung, um alle wichtigen Schritte zu verfolgen.</p>
                <div class="mt-6"><button (click)="showTemplateSelection()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">Checkliste erstellen</button></div>
              </div>
            </ng-template>
          </div>
          <ng-template #loadingChecklist><p class="text-center text-gray-500 py-10">Lade Checkliste...</p></ng-template>
        </div>
        </div> </div> <ng-template #loadingApp>
      <div class="text-center text-gray-500 py-20">Lade Bewerbungsdetails...</div>
    </ng-template>
  
  
    <app-confirmation-dialog *ngIf="showDeleteConfirmation" [message]="confirmationMessage" (confirm)="confirmItemDeletion()" (cancel)="cancelItemDeletion()"></app-confirmation-dialog>
  
    <div *ngIf="isCreatingChecklist" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
      <div class="bg-gray-900 rounded-lg border border-gray-700 p-6 max-w-2xl w-full shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-white">Checkliste erstellen</h3>
          <button (click)="cancelTemplateSelection()" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <div class="mb-4">
          <div class="flex space-x-2 mb-4 border-b border-gray-700 pb-2">
            <button *ngFor="let cat of templateCategories" (click)="selectTemplateCategory(cat.value)" [class.bg-purple-600]="selectedTemplateCategory === cat.value" [class.text-white]="selectedTemplateCategory === cat.value" [class.bg-gray-700]="selectedTemplateCategory !== cat.value" [class.text-gray-300]="selectedTemplateCategory !== cat.value" [class.hover:bg-gray-600]="selectedTemplateCategory !== cat.value" class="px-3 py-1 rounded text-sm transition font-medium">{{ cat.label }}</button>
          </div>
          <div *ngIf="availableTemplates$ | async as templates; else loadingTemplates">
            <div *ngIf="templates.length > 0; else noTemplatesInCategory" class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
              <div *ngFor="let template of templates" (click)="selectTemplate(template)" [class.border-purple-500]="selectedTemplate?.id === template.id" [class.bg-gray-800]="selectedTemplate?.id === template.id" class="border border-gray-700 rounded-lg p-4 cursor-pointer hover:border-gray-600 transition">
                <div class="flex justify-between items-start">
                  <div><h4 class="font-medium text-white">{{ template.name }}</h4><p class="text-sm text-gray-400">{{ template.description || 'Keine Beschreibung' }}</p></div>
                  <span *ngIf="template.isDefault && template.id !== 'empty-template-id'" class="px-2 py-1 bg-purple-900/50 text-purple-400 text-xs rounded-full ml-2 flex-shrink-0">Standard</span>
                </div>
                <div class="mt-2 text-xs text-gray-500" *ngIf="template.id !== 'empty-template-id'">{{ template.items.length || 0 }} Aufgaben</div>
              </div>
            </div>
            <ng-template #noTemplatesInCategory><div class="text-center py-6 text-gray-500"><p>Keine Vorlagen für diese Kategorie gefunden.</p></div></ng-template>
          </div>
           <ng-template #loadingTemplates><div class="text-center py-6 text-gray-500">Lade Vorlagen...</div></ng-template>
        </div>
        <div class="flex justify-end space-x-3 border-t border-gray-700 pt-4 mt-4">
          <button (click)="cancelTemplateSelection()" class="px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition">Abbrechen</button>
          <button (click)="createChecklistFromTemplate()" [disabled]="!selectedTemplate" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded hover:from-purple-700 hover:to-pink-600 transition disabled:opacity-50 disabled:cursor-not-allowed">Checkliste erstellen</button>
        </div>
      </div>
    </div>
  
    <div *ngIf="isEditingChecklistItem" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
      <div class="bg-gray-900 rounded-lg border border-gray-700 p-6 max-w-xl w-full shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-white">{{ editingExistingItem ? 'Aufgabe bearbeiten' : 'Neue Aufgabe' }}</h3>
          <button (click)="cancelChecklistItemEdit()" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <form [formGroup]="checklistItemForm" (ngSubmit)="saveChecklistItem()" class="space-y-4">
          <div><label for="task" class="block text-sm font-medium text-gray-300 mb-1">Aufgabe</label><input type="text" id="task" formControlName="task" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"><div *ngIf="checklistItemForm.get('task')?.invalid && checklistItemForm.get('task')?.touched" class="text-red-500 text-xs mt-1">Aufgabe ist ein Pflichtfeld</div></div>
          <div><label for="category" class="block text-sm font-medium text-gray-300 mb-1">Kategorie</label><input type="text" id="category" formControlName="category" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"><div *ngIf="checklistItemForm.get('category')?.invalid && checklistItemForm.get('category')?.touched" class="text-red-500 text-xs mt-1">Kategorie ist ein Pflichtfeld</div></div>
          <div><label for="priority" class="block text-sm font-medium text-gray-300 mb-1">Priorität</label><select id="priority" formControlName="priority" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent appearance-none"><option value="high">Hoch</option><option value="medium">Mittel</option><option value="low">Niedrig</option></select></div>
          <div><label for="dueDate" class="block text-sm font-medium text-gray-300 mb-1">Fälligkeitsdatum (optional)</label><input type="date" id="dueDate" formControlName="dueDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"></div>
          <div><label for="notes" class="block text-sm font-medium text-gray-300 mb-1">Notizen (optional)</label><textarea id="notes" formControlName="notes" rows="3" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea></div>
          <div class="flex justify-end space-x-3 border-t border-gray-700 pt-4 mt-4">
            <button type="button" (click)="cancelChecklistItemEdit()" class="px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition">Abbrechen</button>
            <button type="submit" [disabled]="checklistItemForm.invalid" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded hover:from-purple-700 hover:to-pink-600 transition disabled:opacity-50 disabled:cursor-not-allowed">Speichern</button>
          </div>
        </form>
      </div>
    </div>
  
    <div *ngIf="isSavingAsTemplate" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
      <div class="bg-gray-900 rounded-lg border border-gray-700 p-6 max-w-xl w-full shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-white">Als Vorlage speichern</h3>
          <button (click)="cancelSaveAsTemplate()" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <form [formGroup]="templateForm" (ngSubmit)="confirmSaveAsTemplate()" class="space-y-4">
          <div><label for="templateName" class="block text-sm font-medium text-gray-300 mb-1">Name der Vorlage</label><input type="text" id="templateName" formControlName="name" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"><div *ngIf="templateForm.get('name')?.invalid && templateForm.get('name')?.touched" class="text-red-500 text-xs mt-1">Name ist ein Pflichtfeld</div></div>
          <div><label for="templateDescription" class="block text-sm font-medium text-gray-300 mb-1">Beschreibung</label><textarea id="templateDescription" formControlName="description" rows="2" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea><div *ngIf="templateForm.get('description')?.invalid && templateForm.get('description')?.touched" class="text-red-500 text-xs mt-1">Beschreibung ist ein Pflichtfeld</div></div>
          <div><label for="templateCategory" class="block text-sm font-medium text-gray-300 mb-1">Kategorie</label><select id="templateCategory" formControlName="category" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent appearance-none"><option value="standard">Allgemeine Bewerbung</option><option value="initiativ">Initiativbewerbung</option><option value="praktikum">Praktikum</option><option value="international">International</option></select></div>
          <div class="flex items-center pt-2"><input type="checkbox" id="isDefault" formControlName="isDefault" class="h-4 w-4 text-purple-600 rounded border-gray-600 bg-gray-700 focus:ring-purple-500"><label for="isDefault" class="ml-2 text-sm text-gray-300">Als Standard für diese Kategorie setzen</label></div>
          <div class="flex justify-end space-x-3 border-t border-gray-700 pt-4 mt-4">
            <button type="button" (click)="cancelSaveAsTemplate()" class="px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition">Abbrechen</button>
            <button type="submit" [disabled]="templateForm.invalid" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded hover:from-purple-700 hover:to-pink-600 transition disabled:opacity-50 disabled:cursor-not-allowed">Vorlage speichern</button>
          </div>
        </form>
      </div>
    </div>
    </div> 